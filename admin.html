<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ì¹˜ë§¤ì•ˆì‹¬ì„¼í„°</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .admin-header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .admin-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .admin-section h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .user-item, .application-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .user-item.pending { border-left: 4px solid #ffc107; }
        .user-item.approved { border-left: 4px solid #28a745; }
        .user-item.rejected { border-left: 4px solid #dc3545; }
        .application-item.pending { border-left: 4px solid #ffc107; }
        .application-item.approved { border-left: 4px solid #28a745; }
        .application-item.rejected { border-left: 4px solid #dc3545; }
        .application-item.shipped { border-left: 4px solid #17a2b8; }
        .application-item.delivered { border-left: 4px solid #6f42c1; }
        .info-row { display: flex; margin-bottom: 8px; }
        .info-label { font-weight: bold; width: 120px; color: #666; }
        .info-value { flex: 1; }
        .action-buttons { margin-top: 15px; }
        .btn { padding: 8px 16px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-ship { background: #17a2b8; color: white; }
        .btn:hover { opacity: 0.8; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; }
        .stat-label { margin-top: 5px; opacity: 0.9; }
        .refresh-btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>ğŸ¥ ì¹˜ë§¤ì•ˆì‹¬ì„¼í„° ê´€ë¦¬ì í˜ì´ì§€</h1>
        <p>ì‚¬ìš©ì ìŠ¹ì¸ ë° ì‹ ì²­ ê´€ë¦¬</p>
        <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">ì´ ì‚¬ìš©ì</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingUsers">0</div>
            <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalApplications">0</div>
            <div class="stat-label">ì´ ì‹ ì²­</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingApplications">0</div>
            <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸° ì‹ ì²­</div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ìŠ¹ì¸ ì„¹ì…˜ -->
    <div class="admin-section">
        <h2>ğŸ‘¥ ì‚¬ìš©ì ìŠ¹ì¸ ê´€ë¦¬</h2>
        <div id="usersList"></div>
    </div>

    <!-- ì‹ ì²­ ìŠ¹ì¸ ì„¹ì…˜ -->
    <div class="admin-section">
        <h2>ğŸ“¦ ì¡°í˜¸ë¬¼í’ˆ ì‹ ì²­ ê´€ë¦¬</h2>
        <div id="applicationsList"></div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let users = [];
        let applications = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            await Promise.all([
                loadUsers(),
                loadApplications()
            ]);
            updateStats();
        }

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                const result = await apiCall('/api/admin/users');
                if (result.success) {
                    users = result.data;
                    displayUsers(users);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', error);
            }
        }

        // ì‹ ì²­ ëª©ë¡ ë¡œë“œ
        async function loadApplications() {
            try {
                const result = await apiCall('/api/admin/applications');
                if (result.success) {
                    applications = result.data;
                    displayApplications(applications);
                }
            } catch (error) {
                console.error('ì‹ ì²­ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', error);
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
        function displayUsers(userList) {
            const usersList = document.getElementById('usersList');
            
            if (userList.length === 0) {
                usersList.innerHTML = '<p>ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            usersList.innerHTML = userList.map(user => `
                <div class="user-item ${user.status}">
                    <div class="info-row">
                        <span class="info-label">ì´ë¦„:</span>
                        <span class="info-value">${user.name}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì´ë©”ì¼:</span>
                        <span class="info-value">${user.email}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì „í™”ë²ˆí˜¸:</span>
                        <span class="info-value">${user.phone}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì‚¬ìš©ì íƒ€ì…:</span>
                        <span class="info-value">${user.user_type === 'caregiver' ? 'ë³´í˜¸ì' : 'í™˜ì'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ê°€ì…ì¼:</span>
                        <span class="info-value">${formatDate(user.created_at)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ìƒíƒœ:</span>
                        <span class="info-value">${getStatusText(user.status)}</span>
                    </div>
                    ${user.status === 'pending' ? `
                        <div class="action-buttons">
                            <button class="btn btn-approve" onclick="approveUser(${user.id}, 'approve')">ìŠ¹ì¸</button>
                            <button class="btn btn-reject" onclick="approveUser(${user.id}, 'reject')">ê±°ì ˆ</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ì‹ ì²­ ëª©ë¡ í‘œì‹œ
        function displayApplications(applicationList) {
            const applicationsList = document.getElementById('applicationsList');
            
            if (applicationList.length === 0) {
                applicationsList.innerHTML = '<p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            applicationsList.innerHTML = applicationList.map(app => `
                <div class="application-item ${app.status}">
                    <div class="info-row">
                        <span class="info-label">ì‹ ì²­ì:</span>
                        <span class="info-value">${app.user_name} (${app.user_email})</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ìƒí’ˆ:</span>
                        <span class="info-value">${app.product_name}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ìˆ˜ëŸ‰:</span>
                        <span class="info-value">${app.quantity}ê°œ</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ë°°ì†¡ì£¼ì†Œ:</span>
                        <span class="info-value">${app.delivery_address}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì‹ ì²­ì¼:</span>
                        <span class="info-value">${formatDate(app.applied_at)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ìƒíƒœ:</span>
                        <span class="info-value">${getStatusText(app.status)}</span>
                    </div>
                    ${app.request_note ? `
                        <div class="info-row">
                            <span class="info-label">ìš”ì²­ì‚¬í•­:</span>
                            <span class="info-value">${app.request_note}</span>
                        </div>
                    ` : ''}
                    ${app.status === 'pending' ? `
                        <div class="action-buttons">
                            <button class="btn btn-approve" onclick="approveApplication(${app.id}, 'approved')">ìŠ¹ì¸</button>
                            <button class="btn btn-reject" onclick="approveApplication(${app.id}, 'rejected')">ê±°ì ˆ</button>
                        </div>
                    ` : ''}
                    ${app.status === 'approved' ? `
                        <div class="action-buttons">
                            <button class="btn btn-ship" onclick="shipApplication(${app.id})">ë°°ì†¡ ì²˜ë¦¬</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('pendingUsers').textContent = users.filter(u => u.status === 'pending').length;
            document.getElementById('totalApplications').textContent = applications.length;
            document.getElementById('pendingApplications').textContent = applications.filter(a => a.status === 'pending').length;
        }

        // ì‚¬ìš©ì ìŠ¹ì¸/ê±°ì ˆ
        async function approveUser(userId, action) {
            try {
                const result = await apiCall('/api/admin/approve-user', 'POST', {
                    user_id: userId,
                    action: action
                });
                
                if (result.success) {
                    showSuccess(result.message);
                    loadUsers();
                }
            } catch (error) {
                showError(error.message);
            }
        }

        // ì‹ ì²­ ìŠ¹ì¸/ê±°ì ˆ
        async function approveApplication(applicationId, status) {
            try {
                const result = await apiCall('/api/admin/approve-application', 'POST', {
                    application_id: applicationId,
                    status: status
                });
                
                if (result.success) {
                    showSuccess(result.message);
                    loadApplications();
                }
            } catch (error) {
                showError(error.message);
            }
        }

        // ë°°ì†¡ ì²˜ë¦¬
        async function shipApplication(applicationId) {
            const trackingNumber = prompt('ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'TR' + Date.now());
            if (trackingNumber) {
                try {
                    const result = await apiCall('/api/admin/ship-application', 'POST', {
                        application_id: applicationId,
                        tracking_number: trackingNumber
                    });
                    
                    if (result.success) {
                        showSuccess(result.message);
                        loadApplications();
                    }
                } catch (error) {
                    showError(error.message);
                }
            }
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ìŠ¹ì¸ ëŒ€ê¸°',
                'approved': 'ìŠ¹ì¸ ì™„ë£Œ',
                'rejected': 'ìŠ¹ì¸ ê±°ì ˆ',
                'shipped': 'ë°°ì†¡ ì¤‘',
                'delivered': 'ë°°ì†¡ ì™„ë£Œ'
            };
            return statusMap[status] || status;
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>